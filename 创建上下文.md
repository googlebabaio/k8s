在有证书的机器上
1、生成新的kubeconfig文件
```
kubectl config set-credentials devuser \
--client-certificate=/opt/kubernetes/ssl/devuser.pem \
--client-key=/opt/kubernetes/ssl/devuser-key.pem \
--embed-certs=true \
--kubeconfig=kubeconfig
```

> 特别注意
> embed-certs选项，如果为false，代表里面的秘钥会以路径的方式生成，这个对于非本地的config是不可取的

2、创建集群入口
```
kubectl config set-cluster k8s --server=https://172.18.53.221:6443 --kubeconfig=kubeconfig
```

3、指定集群证书文件
```
kubectl config set-cluster k8s --certificate-authority=/opt/kubernetes/ssl/ca.pem --embed-certs=true --kubeconfig=kubeconfig
```

kubernetes.pem  是集群的证书，有些地方应该是ca
要参考apiserver的配置文件的client-ca-file 一项
```
[Service]
ExecStart=/opt/kubernetes/bin/kube-apiserver \
  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \
  --bind-address=172.18.53.221 \
  --insecure-bind-address=0.0.0.0 \
  --insecure-port=8080 \
  --authorization-mode=Node,RBAC \
  --runtime-config=rbac.authorization.k8s.io/v1 \
  --kubelet-https=true \
  --anonymous-auth=false \
  --basic-auth-file=/opt/kubernetes/ssl/basic-auth.csv \
  --enable-bootstrap-token-auth \
  --token-auth-file=/opt/kubernetes/ssl/bootstrap-token.csv \
  --service-cluster-ip-range=10.1.0.0/16 \
  --service-node-port-range=20000-40000 \
  --tls-cert-file=/opt/kubernetes/ssl/kubernetes.pem \
  --tls-private-key-file=/opt/kubernetes/ssl/kubernetes-key.pem \
  --client-ca-file=/opt/kubernetes/ssl/ca.pem \
  --service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \
  --etcd-cafile=/opt/kubernetes/ssl/ca.pem \
  --etcd-certfile=/opt/kubernetes/ssl/kubernetes.pem \
  --etcd-keyfile=/opt/kubernetes/ssl/kubernetes-key.pem \
  --etcd-servers=https://172.18.53.221:2379,https://172.18.53.223:2379,https://172.18.53.224:2379 \
  --enable-swagger-ui=true \
  --allow-privileged=true \
  --audit-log-maxage=30 \
  --audit-log-maxbackup=3 \
  --audit-log-maxsize=100 \
  --audit-log-path=/opt/kubernetes/log/api-audit.log \
  --event-ttl=1h \
  --v=2 \
  --logtostderr=false \
  --log-dir=/opt/kubernetes/log \
  --enable-swagger-ui=true
```

各种ca，tls，请参考：[https://blog.csdn.net/qq_34463875/article/details/78042852](https://blog.csdn.net/qq_34463875/article/details/78042852)

4、创建环境配置文件context
```
kubectl config set-context k8s \
--cluster=k8s \
--user=devuser \
--namespace=kube-system \
--kubeconfig=kubeconfig
```

注意：
可以加上namespace作为默认的namespace是选项

5、将kubeconfig文件 copy到 /root/.kube/config
mv kubeconfig /root/.kube/config

6、激活上下文
```
kubectl config use-context k8s
```
切换之后看到的新的上下文应该为如下：
```
[root@nazeebodan ~]# kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: REDACTED
    server: https://172.18.53.221:6443
  name: k8s
contexts:
- context:
    cluster: k8s
    namespace: kube-system
    user: devuser
  name: k8s
current-context: k8s
kind: Config
preferences: {}
users:
- name: devuser
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED

```

7、检查kubectl get pod
