<!-- toc -->


# 集群外部服务访问--ingress

service通常只是在集群内部有效，从集群外是无法访问到的。
在kubernets的世界里，服务要对集群外暴漏，有这么几种方式：
- NodePort
- LoadBalancer
- External IPs
- Ingress


## 什么是ingress
```
# kubectl explain ingress
KIND:     Ingress
VERSION:  extensions/v1beta1

DESCRIPTION:
     Ingress is a collection of rules that allow inbound connections to reach
     the endpoints defined by a backend. An Ingress can be configured to give
     services externally-reachable urls, load balance traffic, terminate SSL,
     offer name based virtual hosting etc.
```

Ingress是一种资源，和Pod、Configmap等等类似，也需要一个controller来管理。
之前比较常用的是NodePort，搭配keepalived可以获得一定程度的HA。

NodePort、LoadBalance、External IPs可以认为是L4的，而Ingress则是L7的。

Ingress 是一组允许外部请求进入集群的路由规则的集合。它可以给 Service 提供集群外部访问的 URL，负载均衡，SSL 终止等。

Ingress 起到了智能路由的角色，外部流量到达 Ingress ，再由它按已经制定好的规则分发到不同的后端服务中去。

看起来它很像我们使用的负载均衡器之类的,和Nginx很类似。

## ingress的使用流程
ingress的使用流程是这样的：
1. 集群部署时，创建一个或多个ingress controller，他们会去监听api server
2. 当用户创建Ingress时，controller会通过api server获取新创建的Ingress的信息（主要是vhost、路径、service+port
3. 注意ingress-nginx会直接将service翻译为endpoint，减少了service这一层转换），根据nginx模板生成新的nginx配置文件（主要是proxy_pass到RS）
4. 最后reload nginx重新加载配置。

## Ingress 与 LoadBalancer 类型的 Service 的区别

- Ingress 不是一种 Service 类型
Ingress 是 K8S 中的一种资源类型，我们可以直接通过 kubectl get ingress 的方式获取我们已有的 Ingress 资源。

- Ingress 可以有多种控制器（实现）
  - 社区维护的有两个：
    - 适用于 Google Cloud 的 GLBC
    - NGINX Ingress Controller 它是使用 ConfigMap 存储 NGINX 配置实现的。
  - 第三方的实现：
    - 基于 Envoy 的 Contour;
    - F5 的 F5 BIG-IP Controller;
    - 基于 HAProxy 的 haproxy-ingress;
    - 基于 Istio 的 Control Ingress Traffic;
    - 现代化的反向代理服务器 Traefik;
    - 以及 Kong 支持的 Kong Ingress Controller for Kubernetes
    - NGINX 官方支持的 NGINX Ingress Controller。

## 安装

## 使用
